#!/usr/bin/env bash

set -e

# Function to preserve tag message if it exists
preserve_tag() {
  local tag="$1"
  shift
  if git rev-parse "$tag" >/dev/null 2>&1; then
    # Tag exists, check if it's annotated
    if git cat-file -p "$tag" 2>/dev/null | grep -q "^tag "; then
      # It's an annotated tag, preserve the message
      tag_msg=$(git tag -l --format='%(contents)' "$tag")
      git tag -f -a "$tag" -m "$tag_msg" "$@"
    else
      # It's a lightweight tag, just force update
      git tag -f "$tag" "$@"
    fi
  else
    # Tag doesn't exist, create normally
    git tag -f "$tag" "$@"
  fi
  echo "$tag"
}

# Extract version from commit diff (pyproject.toml or package.json)
# Supports semver with optional pre-release suffix (e.g., 1.2.3, 1.2.3rc1, 1.2.3-alpha.1)
version_from_diff() {
  local commit="${1:-HEAD}"
  local version=""

  # Check pyproject.toml for version = "X.Y.Z" changes (with optional pre-release suffix)
  version=$(git show "$commit" -- pyproject.toml 2>/dev/null | \
    grep -E '^\+.*version\s*=' | \
    grep -oE '[0-9]+\.[0-9]+\.[0-9]+[a-zA-Z0-9._-]*' | head -1)

  if [ -n "$version" ]; then
    echo "$version"
    return
  fi

  # Check package.json for "version": "X.Y.Z" changes (with optional pre-release suffix)
  version=$(git show "$commit" -- package.json 2>/dev/null | \
    grep -E '^\+.*"version"' | \
    grep -oE '[0-9]+\.[0-9]+\.[0-9]+[a-zA-Z0-9._-]*' | head -1)

  if [ -n "$version" ]; then
    echo "$version"
    return
  fi
}

if [ $# -eq 0 ]; then
  # Use commit subject (first line)
  msg="$(git subject)"
  # Match semver with optional pre-release suffix (e.g., v1.2.3, 1.2.3rc1, v1.2.3-alpha.1)
  if [[ $msg =~ ^v?[0-9]+\.[0-9]+\.[0-9]+[a-zA-Z0-9._-]*$ ]]; then
    preserve_tag "$msg"
  else
    # Try to extract version from the commit diff
    version="$(version_from_diff)"
    if [ -n "$version" ]; then
      echo "Detected version bump to $version in commit" >&2
      preserve_tag "$version"
    else
      echo "Usage: $0 [tag]" >&2
      echo "If no [tag] is provided, the current commit message is used as the tag (expected to match /^v?[0-9]+\.[0-9]+\.[0-9]+$/)," >&2
      echo "or the version is extracted from pyproject.toml/package.json changes in the commit." >&2
      exit 1
    fi
  fi
else
  preserve_tag "$@"
fi
