#!/usr/bin/env bash
# Checkout "ours" or "theirs" versions of conflicting files.
# Usage: git conflicting-checkout <ours|theirs> [paths...]

from="$1"; shift
if [ "$from" != "ours" ] && [ "$from" != "theirs" ]; then
  echo "Usage: $0 <ours|theirs> [paths...]" >&2
  exit 1
fi

# Use provided paths or default to all conflicting files
if [ $# -gt 0 ]; then
  # Use provided paths
  paths=("$@")
  echo "Processing ${#paths[@]} specified path(s):"
  printf '\t%s\n' "${paths[@]}"
else
  # Read all conflicting paths
  IFS=$'\n' read -d '' -ra paths < <(git conflicting)
  echo "${#paths[@]} conflicting paths:"
  printf '\t%s\n' "${paths[@]}"
fi

# Process each path
for path in "${paths[@]}"; do
  if [ "$from" = "theirs" ]; then
    # Check if file exists in theirs (MERGE_HEAD or rebase's "theirs")
    if git ls-tree -r MERGE_HEAD -- "$path" &>/dev/null 2>&1 || \
       git ls-tree -r REBASE_HEAD -- "$path" &>/dev/null 2>&1; then
      # File exists in theirs, checkout their version
      git checkout --theirs "$path" && git add "$path"
    else
      # File deleted by theirs, remove it
      git rm -f "$path"
    fi
  else
    # "ours" - check if file exists in ours (HEAD)
    if git ls-tree -r HEAD -- "$path" &>/dev/null 2>&1; then
      # File exists in ours, checkout our version
      git checkout --ours "$path" && git add "$path"
    else
      # File deleted by ours, remove it
      git rm -f "$path"
    fi
  fi
done
